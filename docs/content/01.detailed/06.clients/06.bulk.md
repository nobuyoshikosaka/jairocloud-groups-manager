---
title: clients.bulk
description: mAP Core API V2 の Bulk API を操作するクライアント機能を提供する。
---

## post
mAP Core API に対してバルクリクエスト機能を提供する。

#### 対応エンドポイント
**POST** [/api/v2/Bulk](../02.foundation/03.const.md#map_bulk_endpoint)

#### シグネチャ
```python[groups.py]
def post(
    operations: list[BulkOperation]
    *, access_token: str, client_secret: str
) -> BulkResponsePayload | MapError:
```

#### 依存するライブラリ
- **requests**： HTTP リクエストの送信に使用。
- **pydantic**： リクエストおよびレスポンスのバリデーションおよびシリアライズ・デシリアライズに使用。

#### 引数
| 名前          | 型                  | 説明                                                      |
| ------------- | ------------------- | --------------------------------------------------------- |
| operations    | list[BulkOperation] | 単一の操作をバルクオペレーション形式にしたもののリスト    |
| access_token  | str                 | （キーワード引数） mAP Core APIのアクセストークン         |
| client_secret | str                 | （キーワード引数） mAP Core APIのクライアントシークレット |

#### 戻り値
| 型                                                                           | 説明                                       |
| ---------------------------------------------------------------------------- | ------------------------------------------ |
| [BulkResponsePayload](../03.entities/11.bulk-request.md#bulkresponsepayload) | バルクレスポンス                           |
| [MapError](../03.entities/04.map_error.md#maperror)                          | バルクリクエストに失敗した場合のエラー情報 |

#### エラー
| 型                            | 説明                                 |
| ----------------------------- | ------------------------------------ |
| requests.exceptions.HTTPError | 401 以上の HTTP エラーが発生した場合 |

#### 処理内容
1. [`utils:get_time_stamp`](./05.utils.md#get_time_stamp) を呼び出し、タイムスタンプを取得する。
2. タイムスタンプ及び、引数 `access_token`、`client_secret` をもとに
   [`utils:compute_signature`](./05.utils.md#compute_signature) を呼び出し、署名を生成する。
3. 引数 `operations` をもとに、[`BulkRequestPayload`](../03.entities/11.bulk-request.md#bulkrequestpayload) のインスタンスを作成する。
4. mAP Core API に対してリクエストを送信する。
   - エンドポイント [`MAP_BULK_ENDPOINT`](../02.foundation/03.const.md#map_bulk_endpoint) に対して、POST リクエストを送信する。
    - リクエストヘッダーに以下を付与する。
      | 名前          | 値                                                        |
      | ------------- | --------------------------------------------------------- |
      | Content-Type  | `application/json`（ **requests** により自動設定される）  |
      | Authorization | アクセストークン。 `"Bearer <access_token>"` の形式で付与 |
   - リクエストボディに、`BulkRequestPayload`をシリアライズし、以下のフィールドを追加した JSON を設定する。
      | 名前                                | 値                   |
      | ----------------------------------- | -------------------- |
      | request                             | 認証情報オブジェクト |
      | &nbsp;⤷&nbsp;&nbsp;&nbsp;time_stamp | タイムスタンプ       |
      | &nbsp;⤷&nbsp;&nbsp;&nbsp;signature  | 署名                 |

   - サーバー設定値 [`config.MAP_CORE`](../02.foundation/02.config.md#mapcoreconfig) の `timeout` に従い、タイムアウトを設定する。
5. レスポンスを解析し、HTTPステータスコードに応じた処理を行う。
   - ステータスコードが 200 の場合、レスポンスボディを
     [`BulkResponsePayload`](../03.entities/11.bulk-request.md#bulkresponsepayload) のインスタンスにデシリアライズする。
   - ステータスコードが 400 の場合、レスポンスボディを
     [`MapError`](../03.entities/04.map_error.md#maperror) のインスタンスにデシリアライズする。
   - ステータスコードが401以上の場合、`requests.Response.raise_for_status` を呼び出し 例外 `requests.exceptions.HTTPError` を送出する。
6. デシリアライズされたバルクレスポンス、あるいはエラー情報を戻り値として返す。
