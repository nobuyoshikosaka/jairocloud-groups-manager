
## extract_group_ids
isMemberOf属性からグループIDを取り出す

#### シグネチャ
```python[permission.py]
def extract_group_ids(is_member_of: str) -> list[str]:
```

#### 引数
| 名前         | 型  | 説明           |
| ------------ | --- | -------------- |
| is_member_of | str | isMemberOf属性 |

#### 戻り値
| 型        | 説明                   |
| --------- | ---------------------- |
| list[str] | 所属グループのIDリスト |

#### 処理内容
1. is_member_ofを「/gr/...;」または「/gr/.../」の中身を取り出す
2. グループidのリストに変換し返却する

## is_sysadmin
ログインユーザーがシステム管理者であるかを判定する

#### シグネチャ
```python[permission.py]
def is_systemadmin(is_member_of: str) -> bool:
```

#### 引数
| 名前         | 型  | 説明                             |
| ------------ | --- | -------------------------------- |
| is_member_of | str | ログインユーザーのisMemberOf属性 |

#### 戻り値
| 型   | 説明                                     |
| ---- | ---------------------------------------- |
| bool | ログインユーザーがシステム管理者かどうか |

#### 処理内容
1. [`extract_group_ids`](#extract_group_ids)でグループIDを取得
2. group_idsに`config.GROUPS.id_patterns.system_admin`が含まれていればtrueを返却
3. 含まれていなければfalseを返却

## is_manageable_group_id
編集/削除対象のグループIDがログインユーザーの管理可能範囲に含まれているかを判定する

#### シグネチャ
```python[permission.py]
def is_manageable_group_id(group_id: str) -> bool:
```

#### 引数
| 名前     | 型  | 説明                      |
| -------- | --- | ------------------------- |
| group_id | str | 編集/削除対象のグループID |

#### 戻り値
| 型   | 説明             |
| ---- | ---------------- |
| bool | 管理可能かどうか |

#### 処理内容
1. `current_user.is_sysadmin`がTrueならTrueを返却
2. `services.utils.affiliations::detect_affiliations`を用いてgroup_idをもとにAffiliationを取得
3. ロール用グループならばFalseを返却
4. ロール用グループでなければrepository_idを取得
5. current_user.isMemberOfを引数に[`extract_group_ids`](#extract_group_ids)でグループIDのリストにする
6. jc_{repository_id}_roles_repoadmが含まれているかどうかを返却

## get_user_roles

#### シグネチャ
```python[permission.py]
def get_user_roles(is_member_of: str) -> set[str],set[str]:
```

#### 引数
| 名前         | 型  | 説明                             |
| ------------ | --- | -------------------------------- |
| is_member_of | str | ログインユーザーのisMemberOf属性 |

#### 戻り値
| 型       | 説明                           |
| -------- | ------------------------------ |
| set[str] | ユーザーの持つロール           |
| set[str] | ユーザーが権限を持つリポジトリ |

#### 処理内容
1. is_member_ofを引数に[`extract_group_ids`](#extract_group_ids)でグループIDのリストを取得
2. `services.utils.affiliations:detect_affiliations`を用いて分類する
3. Affiliations.rolesの各要素のrolesをset[str]にまとめuser_roleとする
4. Affiliations.rolesの各要素のrepository_idをset[str]にまとめrepository_idsとする
5. user_role,repository_idsを返却する

## remove_external_info_service
MapServiceオブジェクトからシステム外の情報を除去する

#### シグネチャ
```python[permission.py]
def remove_external_info_service(entity: MapService) -> MapService:
```

#### 引数
| 名前   | 型         | 説明                          |
| ------ | ---------- | ----------------------------- |
| entity | MapService | mAP Coreのserviceエンティティ |

#### 戻り値
| 型         | 説明                          |
| ---------- | ----------------------------- |
| MapService | mAP Coreのserviceエンティティ |

#### 処理内容
1. entity.groupsのvalueをリスト化する
2. `services.utils.affiliations:detect_affiliations`を用いて分類する
3. `current_user.is_sysadmin`がTrueならAffiliationに含まれないグループIDのグループをentity.groupsから取り除く
4. `current_user.is_sysadmin`がFalseならcurrent_user.is_member_ofを引数に[`get_user_roles`]で権限を持つリポジトリIDリストを取得
   - Affiliationのgroupsのrepository_idがリポジトリIDリストに含まれるグループ以外をentity.groupsから取り除く

## remove_external_info_group
MapGroupオブジェクトからシステム外の情報を除去する

#### シグネチャ
```python[permission.py]
def remove_external_info_group(entity: MapGroup) -> MapGroup:
```

#### 引数
| 名前   | 型       | 説明                        |
| ------ | -------- | --------------------------- |
| entity | MapGroup | mAP Coreのgroupエンティティ |

#### 戻り値
| 型       | 説明                        |
| -------- | --------------------------- |
| MapGroup | mAP Coreのgroupエンティティ |

#### 処理内容
1. entity.membersのうちtype="Group"のもののvalueをリスト化する
2. `services.utils.affiliations:detect_affiliations`を用いて分類する
3. `current_user.is_sysadmin`がTrueならAffiliationに含まれないグループIDのグループをentity.groupsから取り除く
4. `current_user.is_sysadmin`がFalseなら[`get_user_roles`]で権限を持つリポジトリIDリストを取得
   - Affiliationのgroupsのrepository_idがリポジトリIDリストに含まれるグループ以外をentity.groupsから取り除く
   - entity.servicesのうちvalueにリポジトリIDリストの要素を含まないものを取り除く

## remove_external_info_user
MapUserオブジェクトからシステム外の情報を除去する

#### シグネチャ
```python[permission.py]
def remove_external_info_user(entity: MapUser) -> MapUser:
```

#### 引数
| 名前   | 型      | 説明                       |
| ------ | ------- | -------------------------- |
| entity | MapUser | mAP Coreのuserエンティティ |

#### 戻り値
| 型      | 説明                       |
| ------- | -------------------------- |
| MapUser | mAP Coreのuserエンティティ |

#### 処理内容
1. entity.groupsのvalueをリスト化する
2. `services.utils.affiliations:detect_affiliations`を用いて分類する
3. `current_user.is_sysadmin`がTrueならAffiliationに含まれないグループIDのグループをentity.groupsから取り除く
4. `current_user.is_sysadmin`がFalseなら[`get_user_roles`]で権限を持つリポジトリIDリストを取得
   - Affiliationのgroupsのrepository_idがリポジトリIDリストに含まれるグループ以外をentity.groupsから取り除く
