---
title: services.bulk
description: 当システムのリソースをまたぐ一括処理に関するビジネスロジックを提供する。
---

## save_file
ファイルを保存する

#### シグネチャ
```python[bulk.py]
def save_file(temporary_id:str, repository_id:str) -> uuid.UUID:
```

#### 引数
| 名前          | 型  | 説明                                 |
| ------------- | --- | ------------------------------------ |
| temporary_id  | str | 仮アップロードされたファイルの識別子 |
| repository_id | str | 選択されたリポジトリの ID            |

#### 戻り値
| 型        | 説明        |
| --------- | ----------- |
| uuid.UUID | ファイル ID |

#### 処理内容
1. temporary_id をもとにファイルを取得する。
2. ファイルが存在しない場合，形式が csv,tsv,excel と異なる場合は ResourceInvalid を送出する。
3. UUIDv7 のファイル ID を作成する。
4. 年/月のディレクトリにファイルを移動する。
5. DB のfiles テーブルに id, file_path, file_content["repositories"] を保存する。
6. ファイル ID を返却する。
7.  例外が発生した場合 [delete_temporary_file](#delete_temporary_file) で temporary_id のファイルを削除したのちその例外を raise する。

## validate_upload_data
アップロードされたデータの検証をおこなう celery のタスク

#### シグネチャ
```python[bulk.py]
def validate_upload_data(temporary_id:uuid.UUID):
```

#### デコレータ
- `@shared_task` : アプリケーションインスタンスに依存せずタスク定義を行うために用いる

#### 引数
| 名前         | 型        | 説明                                 |
| ------------ | --------- | ------------------------------------ |
| temporary_id | uuid.UUID | 仮アップロードされたファイルの識別子 |

#### 戻り値
| 型        | 説明                          |
| --------- | ----------------------------- |
| uuid.UUID | 検証結果を保存したデータの ID |
#### 処理内容
1. temporary_id をもとに files テーブルから file_path ，file_content を取得する。
2. file_content から repository_id を取り出す。
3. repository_id を引数に [`get_repository_member`](#get_repository_member) で `group_ids` と `user_ids` を取得する。
4.  [`UnexpectedResponseError`](../02.foundation/07.exc.md#unexpectedresponseerror) が発生した場合リトライする。
5. [`read_file`](#read_file) を実行しファイル内容からユーザーのリストを取得する。
6. ユーザー情報について以下を繰り返す。
  - ファイル内容に使われている文字の種類や文字数に不正がないか、グループIDが `group_ids` に含まれているか確認する。
  - 内容に問題があれば status をerror,code にエラー内容として[`CheckResult`](../03.entities/13.bulk.md#checkresult) オブジェクトを作成する。
  -  user_id が空白または `user_ids` に含まれていない場合 status をcreate, code をNone，として[`CheckResult`] オブジェクトを作成し `check_result` に追加する。
  -  user_idが `user_ids` に含まれている場合 update_list に追加する。
7. update_list のid で[`client.users.get_by_id`](../06.clients/04.users.md#get_by_id)
8. ファイルのユーザー情報と比較して変更があれば status をupdate として [`CheckResult`] とする。
9. 以下の変更不可能な属性が変更されている場合は status をerror,code にエラー内容，として[`CheckResult`] オブジェクトを作成し `check_result` に追加する。
    - id
    - userName
    - meta
    - eduPersonPrincipalNames
10. 変更がなければ status をskip ，code を None として [`CheckResult`] オブジェクトを作成し `check_result` に追加する。
11. check_result を用いて ValidateSummary を作成する。
12. `user_ids` に含まれているがファイル内容に含まれていない id のユーザー情報を取得し status をskip として list\[`CheckResult`] オブジェクトを作成する。
13. list\[`CheckResult`] をJSON に変形し not_include とする。
14. UUIDv7 の履歴 ID を作成する。
15. 履歴 ID, ファイル ID, operator, ValidateSummary と not_include をupload_history テーブルに保存する。
16. 履歴 ID を戻り値として返す。

## read_file
ファイルを読み込みユーザーデータとして扱いやすいように変換する

#### 依存するライブラリ
- **openpyxl**: Excelファイルを読み込むために必要

#### シグネチャ
```python[bulk.py]
def read_file(temporary_id:str) -> list[UserDetail]:
```

#### 引数
| 名前         | 型        | 説明                                 |
| ------------ | --------- | ------------------------------------ |
| temporary_id | uuid.UUID | 仮アップロードされたファイルの識別子 |

#### 戻り値
| 型                | 説明                       |
| ----------------- | -------------------------- |
| list\[UserDetail] | ファイル内のユーザーデータ |

#### 処理内容
1. temporary_id をもとに DB から file_path を取得する。
2. file_path からファイルを取得する。
3. ファイルが存在しない場合， ResourceNotFound を送出する。
4. 形式が csv,tsv,excel と異なる場合は ResourceInvalid を送出する。
5. ファイルのすべての行に対し以下を繰り返す。
   - ファイルを一行読み込む。
   - `user_id` のキーが存在するか確認する。
   - 存在しなければ `user_id` をキーに辞書型でファイル内容を UserDetail 形式で保存する。
   - 存在すればグループ ID を追加する。
6. UserDetail のリストを取り出し戻り値として返す。

## get_validate_result
upload_history テーブルから結果を取得する

#### シグネチャ
```python[bulk.py]
def get_validate_result(history_id:uuid.UUID) -> ValidateSummary:
```

#### 引数
| 名前       | 型        | 説明    |
| ---------- | --------- | ------- |
| history_id | uuid.UUID | 履歴 ID |

#### 戻り値
| 型              | 説明     |
| --------------- | -------- |
| ValidateSummary | 検証結果 |

#### 処理内容
1. upload_history テーブルと files テーブルを結合し id がhistory_id と一致するデータを取得する。
2. 取得したデータから ValidateSummary を作成して返却する。

## update_users
- アップロードを実行する
- celery のtask で実行する

#### デコレータ
- `@shared_task` : アプリケーションインスタンスに依存せずタスク定義を行うために用いる

#### 引数
| 名前          | 型         | 説明                                                           |
| ------------- | ---------- | -------------------------------------------------------------- |
| task_id       | str        | バリデーションタスクの ID                                      |
| repository_id | str        | 選択されたリポジトリの ID                                      |
| temporary_id  | uuid.UUID  | 仮アップロードされたファイルの識別子                           |
| delete_users  | list\[str] | 削除 (リポジトリ内のグループから除外 )するユーザーの ID リスト |

#### 戻り値
| 型        | 説明    |
| --------- | ------- |
| uuid.UUID | 履歴 ID |

#### 処理内容
1. services.bulk::build_bulk_operations() を実行する。
2. [`save_file`](#save_file) でファイルを保存する。
3. UUIDv7 の履歴 ID を作成する。
4. 履歴 ID とファイル ID ，operator,timestamp,public=True,status="p" でupload_history テーブルに保存する。
5. Bulk オブジェクトをリクエストボディとして [`client.bulk::post`](../06.clients/06.bulk.md#post) を呼び出す。
6. レスポンスを解析しエラーがあれば list\[CheckResult] のstatus をerror に変更し upload_history テーブルの result に保存する。
7. 履歴 ID を戻り値として返す。

## get_upload_result
upload_history テーブルから結果を取得する

#### シグネチャ
```python[bulk.py]
def get_result(history_id:uuid.UUID) -> ResultSummary:
```

#### 引数
| 名前       | 型        | 説明           |
| ---------- | --------- | -------------- |
| history_id | uuid.UUID | 履歴 ID        |
| filter     | list[str] | フィルター項目 |
| size       | int       | ページサイズ   |
| offset     | int       | オフセット     |

#### 戻り値
| 型            | 説明             |
| ------------- | ---------------- |
| ResultSummary | アップロード結果 |

#### 処理内容
1.history_id のデータのうち `results` カラムの中の `status` が filter に含まれるすものを size,offset の範囲で取得する。
1. files_id を id にもつ files テーブルからファイル情報を取得する。
2. 取得したデータから ResultSummary を作成して戻り値として返す。

## delete_temporary_file
一時アップロードされたファイルを削除する

#### デコレータ
- `@shared_task` : アプリケーションインスタンスに依存せずタスク定義を行うために用いる

#### 引数
| 名前         | 型        | 説明                               |
| ------------ | --------- | ---------------------------------- |
| temporary_id | uuid.UUID | アップロードされたファイルの識別子 |

#### 処理内容
1. temporary_id をもとに files テーブルからファイルパスを取得する。
2. 該当するファイルが存在するか確認する。
3. 存在する場合ファイルを削除する。
4. files テーブルからデータを削除する。

## get_repository_member
リポジトリに属する group とユーザーの id を取得する

#### シグネチャ
```python[bulk.py]
def get_repository_member(repository_id: str) -> RepositoryMember:
```

#### 引数
| 名前          | 型  | 説明                      |
| ------------- | --- | ------------------------- |
| repository_id | str | 選択されたリポジトリの ID |

#### 戻り値
| 名前                                | 型               | 説明                                                       |
| ----------------------------------- | ---------------- | ---------------------------------------------------------- |
| -                                   | RepositoryMember | リポジトリに属するグループとユーザーを返却するためのクラス |
| &nbsp; ⤷&nbsp;&nbsp;&nbsp;group_ids | set\[str]        | リポジトリに属する group のid                              |
| &nbsp; ⤷&nbsp;&nbsp;&nbsp;user_ids  | set\[str]        | リポジトリに属する user のid                               |

- 戻り値の型 `RepositoryMember` は `NamedTuple` で定義され、 group_ids および user_ids 属性を持つオブジェクトを戻り値として返す。

#### エラー
| 型                                                                            | 説明                                                                            |
| ----------------------------------------------------------------------------- | ------------------------------------------------------------------------------- |
| [OAuthTokenError](../02.foundation/07.exc.md#oauthtokenerror)                 | アクセストークンが無効または期限切れまたは DB に存在しない場合                  |
| [CredentialsError](../02.foundation/07.exc.md#credentialserror)               | クライアントシークレットが DB に存在しない場合                                  |
| [ResourceInvalid](../02.foundation/07.exc.md#resourceinvalid)                 | ｍ AP Core API のレスポンスが [MapError](../03.entities/04.map_error.md) の場合 |
| [UnexpectedResponseError](../02.foundation/07.exc.md#unexpectedresponseerror) | ｍ AP Core API のサーバーエラー等の予期せぬエラーが発生した場合                 |

#### 処理内容
1. [`token.get_oauth_token`](../05.services/01.token.md#get_oauth_token) でアクセストークンを取得する。
2. [`token.get_client_secret`](../05.services/01.token.md#get_client_secret) でクライアントシークレットを取得する。
3. 認証情報取得時に [`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror),[`CredentialsError`](../02.foundation/07.exc.md#credentialserror) が発生した場合はそのまま送出する。
4. client.groups::search() でrepository_id に紐づくグループのリストを取得する。
5. レスポンスが [MapError](../03.entities/04.map_error.md) の場合 [ResourceInvalid](../02.foundation/07.exc.md#resourceinvalid) を送出する。
6. ｍ AP Core API のサーバーエラー等が発生した場合 [`UnexpectedResponseError`](../02.foundation/07.exc.md#unexpectedresponseerror) を送出する。
7. グループ ID のリストと members から MemberUser のID のリストを作成する。
8. RepositoryMember オブジェクトを作成する。
9. RepositoryMember を戻り値として返す。
