---
title: services.groups
description: 当システムのグループ管理に関するビジネスロジックを提供する。
---

## creat
グループを作成する。

#### シグネチャ
```python[groups.py]
def creat(group:GroupDetail) -> GroupDetail:
```

#### 引数
| 変数名 | 型                                                           | 説明                   |
| ------ | ------------------------------------------------------------ | ---------------------- |
| group  | [GroupDetail](../03.entities/09.group-detail.md#groupdetail) | 作成するグループの情報 |

#### 戻り値

| 型                                                           | 説明                 |
| ------------------------------------------------------------ | -------------------- |
| [GroupDetail](../03.entities/09.group-detail.md#groupdetail) | グループオブジェクト |

#### エラー
| 型                                                                            | 説明                                                                        |
| ----------------------------------------------------------------------------- | --------------------------------------------------------------------------- |
| [OAuthTokenError](../02.foundation/07.exc.md#oauthtokenerror)                 | アクセストークンが無効または期限切れまたはDBからの取得に失敗した場合        |
| [CredentialsError](../02.foundation/07.exc.md#credentialserror)               | クライアントシークレットがDBからの取得に失敗した場合                        |
| [ResourceInvalid](../02.foundation/07.exc.md#resourceinvalid)                 | ｍAP Core APIのレスポンスが[MapError](../03.entities/04.map_error.md)の場合 |
| [UnexpectedResponseError](../02.foundation/07.exc.md#unexpectedresponseerror) | ｍAP Core APIのサーバーエラー等の予期せぬエラーが発生した場合               |

#### 処理内容
1. 引数の`group`の属性をもとに、新しい[`MapGroup`](../03.entities/02.map-group.md#mapgroup)オブジェクトを作成する。
2. サーバー設定値のシステム管理者IDを[`MapGroup`](../03.entities/02.map-group.md#mapgroup)オブジェクトの[`members`](../03.entities/02.map-group.md#member)と[`administrator`](../03.entities/02.map-group.md#administrator)に含める。
3. [`token.get_oauth_token`](../05.services/01.token.md#get_oauth_token)でアクセストークンを取得する。
4. [`token.get_client_secret`](../05.services/01.token.md#get_client_secret)でクライアントシークレットを取得する。
5. 認証情報取得時に[`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror),[`CredentialsError`](../02.foundation/07.exc.md#credentialserror)が発生した場合はそのまま送出する。
6. [`client.groups:post`](../06.clients/03.groups.md#post)を呼び出す。
7. アクセストークンが無効または期限切れの場合[`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror)を送出する。
8. ｍAP Core APIのサーバーエラー等が発生した場合[`UnexpectedResponseError`](../02.foundation/07.exc.md#unexpectedresponseerror)を送出する。
9. レスポンスが[`MapError`](../03.entities/04.map_error.md)の場合[`ResourceInvalid`](../02.foundation/07.exc.md#resourceinvalid)を送出する。
10. 作成されたグループ情報を[`GrouprDetail`](../03.entities/09.group-detail.md)オブジェクトにマッピングする。
11. 作成されたグループ詳細情報オブジェクトを返す。

## get_by_id
idをもとにグループ詳細情報を取得する。

#### シグネチャ
```python[groups.py]
def get_by_id(group_id:str) -> GroupDetail | None:
```

#### 引数
| 変数名   | 型  | 説明                 |
| -------- | --- | -------------------- |
| group_id | str | 取得するグループのid |

#### 戻り値

| 型                                                           | 説明                 |
| ------------------------------------------------------------ | -------------------- |
| [GroupDetail](../03.entities/09.group-detail.md#groupdetail) | グループオブジェクト |

#### エラー
| 型                                                                            | 説明                                                          |
| ----------------------------------------------------------------------------- | ------------------------------------------------------------- |
| [OAuthTokenError](../02.foundation/07.exc.md#oauthtokenerror)                 | アクセストークンが無効または期限切れまたはDBに存在しない場合  |
| [CredentialsError](../02.foundation/07.exc.md#credentialserror)               | クライアントシークレットがDBに存在しない場合                  |
| [UnexpectedResponseError](../02.foundation/07.exc.md#unexpectedresponseerror) | ｍAP Core APIのサーバーエラー等の予期せぬエラーが発生した場合 |

#### 処理内容
1. [`token.get_oauth_token`](../05.services/01.token.md#get_oauth_token)でアクセストークンを取得する。
2. [`token.get_client_secret`](../05.services/01.token.md#get_client_secret)でクライアントシークレットを取得する。
3. 認証情報取得時に[`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror),[`CredentialsError`](../02.foundation/07.exc.md#credentialserror)が発生した場合はそのまま送出する。
4. [`client.groups:get_by_id`](../06.clients/03.groups.md#get_by_id)を呼び出す。
5. アクセストークンが無効または期限切れの場合[`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror)を送出する。
6. ｍAP Core APIのサーバーエラー等が発生した場合[`UnexpectedResponseError`](../02.foundation/07.exc.md#unexpectedresponseerror)を送出する。
7. レスポンスが[`MapError`](../03.entities/04.map_error.md)の場合`None`を返す。
8. 取得したグループ情報を[`GrouprDetail`](../03.entities/09.group-detail.md#groupdetail)オブジェクトにマッピングする。
9. 取得したグループ詳細情報オブジェクトを返す。


## update
グループを更新する。

#### シグネチャ
```python[groups.py]
def update(group:GroupDetail) -> GroupDetail:
```

#### 引数
| 変数名 | 型                                                           | 説明                   |
| ------ | ------------------------------------------------------------ | ---------------------- |
| group  | [GroupDetail](../03.entities/09.group-detail.md#groupdetail) | 更新するグループの情報 |

#### 戻り値

| 型                                                           | 説明                           |
| ------------------------------------------------------------ | ------------------------------ |
| [GroupDetail](../03.entities/09.group-detail.md#groupdetail) | 更新されたグループオブジェクト |

#### エラー
| 型                                                                            | 説明                                                                        |
| ----------------------------------------------------------------------------- | --------------------------------------------------------------------------- |
| [OAuthTokenError](../02.foundation/07.exc.md#oauthtokenerror)                 | アクセストークンが無効または期限切れまたはDBに存在しない場合                |
| [CredentialsError](../02.foundation/07.exc.md#credentialserror)               | クライアントシークレットがDBに存在しない場合                                |
| [ResourceInvalid](../02.foundation/07.exc.md#resourceinvalid)                 | ｍAP Core APIのレスポンスが[MapError](../03.entities/04.map_error.md)の場合 |
| [ResourceNotFound](../02.foundation/07.exc.md#resourcenotfound)               | 更新するグループが存在しない場合                                            |
| [UnexpectedResponseError](../02.foundation/07.exc.md#unexpectedresponseerror) | ｍAP Core APIのサーバーエラー等の予期せぬエラーが発生した場合               |

#### 処理内容
1. [`token.get_access_token`](../05.services/01.token.md#get_oauth_token)でアクセストークンを取得する。
2. [`token.get_client_secret`](../05.services/01.token.md#get_client_secret)でクライアントシークレットを取得する。
3. 認証情報取得時に[`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror),[`CredentialsError`](../02.foundation/07.exc.md#credentialserror)が発生した場合はそのまま送出する。
4. [`client.groups:get_by_id`](../06.clients/03.groups.md#get_by_id)を呼び出す。
5. アクセストークンが無効または期限切れの場合[`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror)を送出する。
6. ｍAP Core APIのサーバーエラー等が発生した場合[`UnexpectedResponseError`](../02.foundation/07.exc.md#unexpectedresponseerror)を送出する。
7. レスポンスが[`MapError`](../03.entities/04.map_error.md)の場合[`ResourceNotFound`](../02.foundation/07.exc.md#resourcenotfound)を送出する。
8.  現在登録されている情報と`group`を用いて`build_patch_operations`で`list[PatchOperation]`を作成する。
9.  `exclude`に`"meta","members","administrator"`を設定し、[`client.groups:patch_by_id`](../06.clients/03.groups.md#patch_by_id)を呼び出す。
10. 更新されたグループ情報を[`GrouprDetail`](../03.entities/09.group-detail.md#groupdetail)オブジェクトにマッピングする。
11. 更新されたグループ詳細情報オブジェクトを返す。


## delete
複数のグループを削除する。

#### シグネチャ
```python[groups.py]
def delete(group_ids:list[str]) -> list[tuple[str, str]]| None:
```

#### 引数
| 変数名    | 型        | 説明                       |
| --------- | --------- | -------------------------- |
| group_ids | list[str] | 削除するグループのidリスト |

#### 戻り値
| 型                    | 説明                                 |
| --------------------- | ------------------------------------ |
| None                  | すべてのグループの削除成功時         |
| list[tuple[str, str]] | 削除に失敗したグループIDとdetailの組 |

#### エラー
| 型                                                                            | 説明                                                                        |
| ----------------------------------------------------------------------------- | --------------------------------------------------------------------------- |
| [OAuthTokenError](../02.foundation/07.exc.md#oauthtokenerror)                 | アクセストークンが無効または期限切れまたはDBに存在しない場合                |
| [CredentialsError](../02.foundation/07.exc.md#credentialserror)               | クライアントシークレットがDBに存在しない場合                                |
| [ResourceInvalid](../02.foundation/07.exc.md#resourceinvalid)                 | ｍAP Core APIのレスポンスが[MapError](../03.entities/04.map_error.md)の場合 |
| [UnexpectedResponseError](../02.foundation/07.exc.md#unexpectedresponseerror) | ｍAP Core APIのサーバーエラー等の予期せぬエラーが発生した場合               |

#### 処理内容
1. group_idsをもとにBulkオペレーションのリクエストボディを作成する。
2. [`token.get_oauth_token`](../05.services/01.token.md#get_oauth_token)でアクセストークンを取得する。
3. [`token.get_client_secret`](../05.services/01.token.md#get_client_secret)でクライアントシークレットを取得する。
4. 認証情報取得時に[`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror),[`CredentialsError`](../02.foundation/07.exc.md#credentialserror)が発生した場合はそのまま送出する。
5. [`client.bulk:post`](../06.clients/06.bulk.md#post)を呼び出す。
6. アクセストークンが無効または期限切れの場合[`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror)を送出する。
7. ｍAP Core APIのサーバーエラー等が発生した場合[`UnexpectedResponseError`](../02.foundation/07.exc.md#unexpectedresponseerror)を送出する。
8. レスポンスが[`MapError`](../03.entities/04.map_error.md)の場合[`ResourceNotFound`](../02.foundation/07.exc.md#resourcenotfound)を送出する。
9. すべて削除に成功していればNoneを返す。
10. 削除に失敗したグループがあればグループIDと[`response`](../03.entities/11.bulk-request.md#bulkoperation)に含まれるerrorエンティティのdetailをtupleにしてリストで返す。

## delete_by_id
単一のグループを削除する。

#### シグネチャ
```python[groups.py]
def delete_by_id(group_id:str) -> None:
```

#### 引数
| 変数名    | 型  | 説明                 |
| --------- | --- | -------------------- |
| group_ids | str | 削除するグループのid |


#### エラー
| 型                                                                            | 説明                                                                        |
| ----------------------------------------------------------------------------- | --------------------------------------------------------------------------- |
| [OAuthTokenError](../02.foundation/07.exc.md#oauthtokenerror)                 | アクセストークンが無効または期限切れまたはDBに存在しない場合                |
| [CredentialsError](../02.foundation/07.exc.md#credentialserror)               | クライアントシークレットがDBに存在しない場合                                |
| [ResourceInvalid](../02.foundation/07.exc.md#resourceinvalid)                 | ｍAP Core APIのレスポンスが[MapError](../03.entities/04.map_error.md)の場合 |
| [ResourceNotFound](../02.foundation/07.exc.md#resourcenotfound)               | 更新するグループが存在しない場合                                            |
| [UnexpectedResponseError](../02.foundation/07.exc.md#unexpectedresponseerror) | ｍAP Core APIのサーバーエラー等の予期せぬエラーが発生した場合               |

#### 処理内容
1. [`token.get_oauth_token`](../05.services/01.token.md#get_oauth_token)でアクセストークンを取得する。
2. [`token.get_client_secret`](../05.services/01.token.md#get_client_secret)でクライアントシークレットを取得する。
3. 認証情報取得時に[`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror),[`CredentialsError`](../02.foundation/07.exc.md#credentialserror)が発生した場合はそのまま送出する。
4. [`client.group:delete_by_id`](../06.clients/03.groups.md#delete_by_id)を呼び出す。
5. アクセストークンが無効または期限切れの場合[`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror)を送出する。
6. ｍAP Core APIのサーバーエラー等が発生した場合[`UnexpectedResponseError`](../02.foundation/07.exc.md#unexpectedresponseerror)を送出する。
7. レスポンスが[`MapError`](../03.entities/04.map_error.md)の場合[`ResourceNotFound`](../02.foundation/07.exc.md#resourcenotfound)を送出する。

## get
グループ一覧を取得する。

#### シグネチャ
```python[groups.py]
def get(query:GroupSearchCriteria) -> list[GrouprDetail]:
```

#### 引数
| 変数名 | 型                  | 説明                                 |
| ------ | ------------------- | ------------------------------------ |
| query  | GroupSearchCriteria | 取得するグループを絞り込むフィルター |

#### 戻り値

| 型          | 説明                       |
| ----------- | -------------------------- |
| GroupResult | グループオブジェクトの一覧 |

#### エラー
| 型                                                                            | 説明                                                                        |
| ----------------------------------------------------------------------------- | --------------------------------------------------------------------------- |
| [OAuthTokenError](../02.foundation/07.exc.md#oauthtokenerror)                 | アクセストークンが無効または期限切れまたはDBに存在しない場合                |
| [CredentialsError](../02.foundation/07.exc.md#credentialserror)               | クライアントシークレットがDBに存在しない場合                                |
| [ResourceInvalid](../02.foundation/07.exc.md#resourceinvalid)                 | ｍAP Core APIのレスポンスが[MapError](../03.entities/04.map_error.md)の場合 |
| [UnexpectedResponseError](../02.foundation/07.exc.md#unexpectedresponseerror) | ｍAP Core APIのサーバーエラー等の予期せぬエラーが発生した場合               |

#### 処理内容
1. GroupSearchCriteriaをrequest_parmとする。
2. [`token.get_oauth_token`](../05.services/01.token.md#get_oauth_token)でアクセストークンを取得する。
3. [`token.get_client_secret`](../05.services/01.token.md#get_client_secret)でクライアントシークレットを取得する。
4. 認証情報取得時に[`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror),[`CredentialsError`](../02.foundation/07.exc.md#credentialserror)が発生した場合はそのまま送出する。
5. [`client.groups:search`]を呼び出す。
6. レスポンスが[MapError](../03.entities/04.map_error.md)の場合[ResourceInvalid](../02.foundation/07.exc.md#resourceinvalid)を送出する。
7. グループ情報を`GroupSummary`オブジェクトにマッピングする。
8. `GroupSummary`のリストをもとに`GroupResult`を作成する。
9. `GroupResult`を返す。


## update_member
グループメンバーの追加/除外を行う。

#### シグネチャ
```python[groups.py]
def update_member(add:list[str], remove:list[str], group_id: str) -> GrouprDetail:
```

#### 引数
| 引数名   | 型        | 説明                          |
| -------- | --------- | ----------------------------- |
| group_id | str       | 追加/除外する対象のグループID |
| add      | list[str] | 追加するユーザーのID          |
| remove   | list[str] | 除外するユーザーのID          |

#### 戻り値
| 型                                                           | 説明                           |
| ------------------------------------------------------------ | ------------------------------ |
| [GroupDetail](../03.entities/09.group-detail.md#groupdetail) | 更新されたグループオブジェクト |

#### エラー
| 型                                                                            | 説明                                                                        |
| ----------------------------------------------------------------------------- | --------------------------------------------------------------------------- |
| [OAuthTokenError](../02.foundation/07.exc.md#oauthtokenerror)                 | アクセストークンが無効または期限切れまたはDBに存在しない場合                |
| [CredentialsError](../02.foundation/07.exc.md#credentialserror)               | クライアントシークレットがDBに存在しない場合                                |
| [RequestConflict](../02.foundation/07.exc.md#requestconflict)                 | リクエスト内容に競合がある場合                                              |
| [ResourceInvalid](../02.foundation/07.exc.md#resourceinvalid)                 | ｍAP Core APIのレスポンスが[MapError](../03.entities/04.map_error.md)の場合 |
| [UnexpectedResponseError](../02.foundation/07.exc.md#unexpectedresponseerror) | ｍAP Core APIのサーバーエラー等の予期せぬエラーが発生した場合               |

#### 処理内容
1. group_idをもとに[`get_by_id`](#get_by_id)を呼び出し、現在所属しているメンバーリストを確認する。
2. addに現在所属しているユーザーIDが含まれていれば取り除く。
3. removeに現在所属していないユーザーID，サーバー設定値のシステム管理者IDが含まれていれば取り除く。
4. removeのメンバーを取り除いても所属するメンバーが0にならないことを確認し0になる場合はaddにシステム管理者IDを追加する。
5. addとremoveに同一のグループIDが存在する場合[RequestConflict](../02.foundation/07.exc.md#requestconflict)を送出する。
6. `build_update_member_operations`でlist\[PatchOperation]を作成する。
7. `include`に`"members"`を設定し、[`client.groups:patch_by_id`](../06.clients/03.groups.md#patch_by_id)を呼び出す。
8.  更新されたグループ情報を[`GrouprDetail`](../03.entities/09.group-detail.md)オブジェクトにマッピングする。
9.  更新されたグループ詳細情報オブジェクトを返す。
