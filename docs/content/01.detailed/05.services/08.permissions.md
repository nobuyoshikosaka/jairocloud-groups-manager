---
title: services.permissions
description: 当システムの認証・セッションに関するビジネスロジックを提供する。
---

## extract_group_ids
isMemberOf 属性からグループ ID を取り出す

#### シグネチャ
```python[permissions.py]
def extract_group_ids(is_member_of: str) -> list[str]:
```

#### 引数
| 名前         | 型  | 説明            |
| ------------ | --- | --------------- |
| is_member_of | str | isMemberOf 属性 |

#### 戻り値
| 型        | 説明                     |
| --------- | ------------------------ |
| list[str] | 所属グループの ID リスト |

#### 処理内容
1. is_member_of を「 /gr/...; 」または「 /gr/.../ 」の中身を取り出す
2. グループ id のリストに変換し返却する

## is_current_user_system_admin
ログインユーザーがシステム管理者であるかを判定する

#### シグネチャ
```python[permissions.py]
def is_current_user_system_admin() -> bool:
```

#### 戻り値
| 型   | 説明                                     |
| ---- | ---------------------------------------- |
| bool | ログインユーザーがシステム管理者かどうか |

#### 処理内容
1. `current_user.is_meber_of` からログインユーザーの is_member_of 属性を取得する
2. [`extract_group_ids`](#extract_group_ids) でグループ ID を取得
3. group_ids に`config.GROUPS.id_patterns.system_admin` が含まれていれば true を返却
4. 含まれていなければ false を返却

## get_permitted_repository_ids
ログインユーザーの権限を持つリポジトリ ID を取得する

#### シグネチャ
```python[permissions.py]
def get_permitted_repository_ids() -> set[str]:
```

#### 戻り値
| 型        | 説明                   |
| --------- | ---------------------- |
| set\[str] | 権限を持つリポジトリID |

#### 処理内容
1. `current_user.is_meber_of` からログインユーザーの is_member_of 属性を取得する
2. [`extract_group_ids`](#extract_group_ids) を呼び出しグループ ID の set に変換する
3. `detect_affiliations` を呼び出し所属するロールグループを取得する
4. 取得したロールグループのうちリポジトリ管理者ロールのリポジトリ ID を set に変換し戻り値として返す

## filter_permitted_group_ids
グループ ID がログインユーザーの権限範囲に含まれているかを判定する

#### シグネチャ
```python[permissions.py]
def filter_permitted_group_ids(*group_id: str) -> set[str]:
```

#### 引数
| 名前      | 型  | 説明                     |
| --------- | --- | ------------------------ |
| *group_id | str | グループ ID (可変長引数) |

#### 戻り値
| 型        | 説明                 |
| --------- | -------------------- |
| set\[str] | 権限を持つグループID |

#### 処理内容
1. `get_permitted_repository_ids` を呼び出し、権限を持つリポジトリ ID を取得する
2. `group_id` を引数に `services.utils.affiliations:detect_affiliations` を用いて Affiliation を取得
3. Affiliation.groups のうち 権限を持つリポジトリ ID を持つグループを set に変換し 返却する

## get_login_user_roles
ログインユーザーのロール権限を取得する

#### シグネチャ
```python[permissions.py]
def get_login_user_roles() -> Affiliation:
```

#### 戻り値
| 型          | 説明               |
| ----------- | ------------------ |
| Affiliation | グループの所属関係 |

#### 処理内容
1. `current_user.is_meber_of` からログインユーザーの is_member_of 属性を取得する
2. [`extract_group_ids`](#extract_group_ids) を呼び出しグループ ID の set に変換する
3. `detect_affiliations` を呼び出しグループの所属関係を取得し戻り値として返す

## remove_info_outside_system 
システム外の情報を除去する関数

#### シグネチャ
```python[permissions.py]
def remove_info_outside_system(entity: MapService | MapGroup | MapUser) -> MapService | MapGroup | MapUser:
```

#### 引数
| 名前   | 型                                | 説明                    |
| ------ | --------------------------------- | ----------------------- |
| entity | MapService \| MapGroup \| MapUser | mAP Core のエンティティ |

#### 戻り値
| 型                                | 説明                    |
| --------------------------------- | ----------------------- |
| MapService \| MapGroup \| MapUser | mAP Core のエンティティ |

#### 処理内容
1. 引数 `entity` のタイプを確認する
   - MapService ならば [`remove_external_info_service`](#remove_external_info_service) を呼び出す
   - MapGroup ならば [`remove_external_info_grou`](#remove_external_info_group) を呼び出す
   - MapUser ならば [`remove_external_info_user`](#remove_external_info_user) を呼び出す
2. 呼び出した関数の戻り値を戻り値として返す

## remove_external_info_service
MapService オブジェクトからシステム外の情報を除去する

#### シグネチャ
```python[permissions.py]
def remove_external_info_service(entity: MapService) -> MapService:
```

#### 引数
| 名前   | 型         | 説明                            |
| ------ | ---------- | ------------------------------- |
| entity | MapService | mAP Core のservice エンティティ |

#### 戻り値
| 型         | 説明                            |
| ---------- | ------------------------------- |
| MapService | mAP Core のservice エンティティ |

#### 処理内容
1. entity.groups のvalue をリスト化する
2. `services.utils.affiliations:detect_affiliations` を用いて分類する
3. `current_user.is_system_admin` がTrue なら Affiliation に含まれないグループ ID のグループを entity.groups から取り除く
4. `current_user.is_system_admin` がFalse なら [] で権限を持つリポジトリ ID リストを取得
   - Affiliation のgroups のrepository_id がリポジトリ ID リストに含まれるグループ以外を entity.groups から取り除く

## remove_external_info_group
MapGroup オブジェクトからシステム外の情報を除去する

#### シグネチャ
```python[permissions.py]
def remove_external_info_group(entity: MapGroup) -> MapGroup:
```

#### 引数
| 名前   | 型       | 説明                          |
| ------ | -------- | ----------------------------- |
| entity | MapGroup | mAP Core のgroup エンティティ |

#### 戻り値
| 型       | 説明                          |
| -------- | ----------------------------- |
| MapGroup | mAP Core のgroup エンティティ |

#### 処理内容
1. entity.members のうち type="Group" のものの value をリスト化する
2. `services.utils.affiliations:detect_affiliations` を用いて分類する
3. `current_user.is_system_admin` がTrue なら Affiliation に含まれないグループ ID のグループを entity.groups から取り除く
4. `current_user.is_system_admin` がFalse なら [`get_login_user_roles`] で権限を持つリポジトリ ID リストを取得
   - Affiliation のgroups のrepository_id がリポジトリ ID リストに含まれるグループ以外を entity.groups から取り除く
   - entity.services のうち value にリポジトリ ID リストの要素を含まないものを取り除く

## remove_external_info_user
MapUser オブジェクトからシステム外の情報を除去する

#### シグネチャ
```python[permissions.py]
def remove_external_info_user(entity: MapUser) -> MapUser:
```

#### 引数
| 名前   | 型      | 説明                         |
| ------ | ------- | ---------------------------- |
| entity | MapUser | mAP Core のuser エンティティ |

#### 戻り値
| 型      | 説明                         |
| ------- | ---------------------------- |
| MapUser | mAP Core のuser エンティティ |

#### 処理内容
1. entity.groups のvalue をリスト化する
2. `services.utils.affiliations:detect_affiliations` を用いて分類する
3. `current_user.is_system_admin` がTrue なら Affiliation に含まれないグループ ID のグループを entity.groups から取り除く
4. `current_user.is_system_admin` がFalse なら [`get_login_user_roles`] で権限を持つリポジトリ ID リストを取得
   - Affiliation のgroups のrepository_id がリポジトリ ID リストに含まれるグループ以外を entity.groups から取り除く
