---
title: config
description: サーバー設定値の管理機能を提供する。
---

## RuntimeConfig
サーバー設定値を管理するクラス。  
運用上適切な値を設定することを想定したサーバ設定値を外部から読み込む機能を提供する。
安全な設定値の一元管理と、プロパティによる動的生成を担う。  

#### シグネチャ
```python[config.py]
class RuntimeConfig(pydantic_settings.BaseSettings):
```

#### 依存するライブラリ
- **Pydantic / pydantic-settings**： 設定値の型安全管理・読み込みに使用。
- **SQLAlchemy**： データベース接続 URI の型にこのライブラリの型を使用。

#### 継承元
`pydantic_settings.BaseSettings`

#### クラス属性

| 名前        | 型                                | 説明                  |
| ----------- | --------------------------------- | --------------------- |
| SERVER_NAME | str                               | サーバ名              |
| SECRET_KEY  | str                               | 暗号化用キー          |
| LOG         | [LogConfig](#logconfig)           | ログ設定              |
| SP          | [SpConfig](#spconfig)             | SP 設定               |
| MAP_CORE    | [MapCoreConfig](#mapcoreconfig)   | mAP Core サービス設定 |
| CELERY      | [CeleryConfig](#celeryconfig)     | Celery 設定           |
| POSTGRES    | [PostgresConfig](#postgresconfig) | Postgres 設定         |

#### プロパティ  
これらは `@computed_field` デコレータを使用し、他の属性値から算出される値で属性としてアクセスされる。  

| プロパティ名            | 型                    | 説明                |
| ----------------------- | --------------------- | ------------------- |
| SQLALCHEMY_DATABASE_URI | sqlalchemy.engine.URL | データベース接続URI |

#### メソッド

| 名前                         | 型    | 説明                                   |
| ---------------------------- | ----- | -------------------------------------- |
| settings_customise_sources() | tuple | 設定値の読み込み順序を制御するメソッド |

### SQLALCHEMY_DATABASE_URI
Postgres 設定値をもとにデータベース接続 URI を生成するプロパティ。
Flask-SQLAlchemy はこの値を使用してデータベース接続を行う。

#### シグネチャ
```python[config.py]
@computed_field
@cached_property
def SQLALCHEMY_DATABASE_URI(self) -> sqlalchemy.engine.URL:
```

#### デコレータ
- `@computed_field`： Pydantic の計算フィールドを定義するデコレータ。
- `@cached_property`： プロパティの結果をキャッシュするデコレータ。

#### 処理内容
1. 属性 `POSTGRES` の各値を使用して、SQLAlchemy のデータベース接続 URI を生成する。
   スキーマは `postgresql+psycopg` を使用する。
2. 生成したデータベース接続 URI を返す。


### settings_customise_sources
設定値の読み込みを制御するメソッド。  
標準で提供される設定ソースに加え、TOML ファイルからの読み込みを追加する。
戻り値のタプルに含まれる順序で設定ソースが適用される。

#### シグネチャ
```python[config.py]
@override
@classmethod
def settings_customise_sources(
    cls, settings_cls: type[BaseSettings],
    init_settings: PydanticBaseSettingsSource,
    env_settings: PydanticBaseSettingsSource,
    dotenv_settings: PydanticBaseSettingsSource,
    file_secret_settings: PydanticBaseSettingsSource
) -> tuple[PydanticBaseSettingsSource, ...]:
```

#### デコレータ
- `@override`： メソッドがスーパークラスのメソッドをオーバーライドしていることを示すデコレータ。
- `@classmethod`： クラスメソッドを定義するデコレータ。

#### 引数

| 名前                 | 型                         | 説明                                    |
| -------------------- | -------------------------- | --------------------------------------- |
| settings_cls         | type\[BaseSettings\]       | 設定クラスの型                          |
| init_settings        | PydanticBaseSettingsSource | コンストラクタ引数からの設定ソース      |
| env_settings         | PydanticBaseSettingsSource | 環境変数からの設定ソース                |
| dotenv_settings      | PydanticBaseSettingsSource | .env ファイルからの設定ソース           |
| file_secret_settings | PydanticBaseSettingsSource | Kubernetes シークレットからの設定ソース |

#### 戻り値
| 型                                       | 説明                             |
| ---------------------------------------- | -------------------------------- |
| tuple\[PydanticBaseSettingsSource, ...\] | カスタムされた設定ソースのタプル |

#### 処理内容
1. スーパークラスの `settings_customise_sources` メソッドを呼び出し、標準の設定ソースタプルを取得する。
2. 引数 `init_settings` から `_toml_file` キーを取り出し、TOML ファイルのパスを取得する。
3. TOML ファイルのパスが存在しない場合、標準の設定ソースタプルをそのまま戻り値として返す。  
   存在する場合、設定ソースタプルの末尾に TOML ファイルのパスで初期化した `pydantic_settings.TomlSettingsSource` を追加し、戻り値として返す。


## LogConfig
アプリケーションログに関するサーバー設定値を管理するクラス。[`RuntimeConfig`](#runtimeconfig) でネストした設定値として使用される。

#### シグネチャ
```python[config.py]
class LogConfig(pydantic.BaseModel):
```

#### 依存するライブラリ
- **Pydantic**： 設定値の型安全管理に使用。

#### 継承元
`pydantic.BaseModel`

#### クラス属性

| 名前    | 型  | 説明             |
| ------- | --- | ---------------- |
| level   | str | ログレベル       |
| format  | str | ログフォーマット |
| datefmt | str | 日付フォーマット |


## SpConfig
SP 関連のサーバー設定値を管理するクラス。[`RuntimeConfig`](#runtimeconfig) でネストした設定値として使用される。

#### シグネチャ
```python[config.py]
class SpConfig(pydantic.BaseModel):
```

#### 依存するライブラリ
- **Pydantic**： 設定値の型安全管理に使用。

#### 継承元
`pydantic.BaseModel`

#### クラス属性

| 名前      | 型  | 説明               |
| --------- | --- | ------------------ |
| entity_id | str | SP エンティティ ID |
| crt       | str | SP 証明書パス      |
| key       | str | SP 秘密鍵パス      |


## MapCoreConfig
mAP Core サービスに関するサーバー設定値を管理するクラス。[`RuntimeConfig`](#runtimeconfig) でネストした設定値として使用される。

#### シグネチャ
```python[config.py]
class MapCoreConfig(pydantic.BaseModel):
```

#### 依存するライブラリ
- **Pydantic**： 設定値の型安全管理に使用。

#### 継承元
`pydantic.BaseModel`

#### クラス属性

| 名前     | 型  | 説明                       |
| -------- | --- | -------------------------- |
| base_url | str | mAP Core サービスの URL    |
| timeout  | int | リクエストタイムアウト秒数 |


## CeleryConfig
Celery アプリケーションに関するサーバー設定値を管理するクラス。[`RuntimeConfig`](#runtimeconfig) でネストした設定値として使用される。

#### シグネチャ
```python[config.py]
class CeleryConfig(pydantic.BaseModel):
```

#### 依存するライブラリ
- **Pydantic**： 設定値の型安全管理に使用。

#### 継承元
`pydantic.BaseModel`

#### クラス属性

| 名前           | 型  | 説明                     |
| -------------- | --- | ------------------------ |
| broker_url     | str | Celery ブローカーのURL   |
| result_backend | str | Celery バックエンドのURL |


## PostgresConfig
Postgres に関するサーバー設定値を管理するクラス。[`RuntimeConfig`](#runtimeconfig) でネストした設定値として使用される。

#### シグネチャ
```python[config.py]
class PostgresConfig(pydantic.BaseModel):
```

#### 依存するライブラリ
- **Pydantic**： 設定値の型安全管理に使用。

#### 継承元
`pydantic.BaseModel`

#### クラス属性

| 名前     | 型  | 説明                   |
| -------- | --- | ---------------------- |
| user     | str | データベースユーザー名 |
| password | str | データベースパスワード |
| host     | str | データベースホスト名   |
| port     | int | データベースポート番号 |
| db       | str | データベース名         |


## setup_config
サーバー設定を初期化する関数。

#### シグネチャ
```python[config.py]
def setup_config(path_or_obj: str | RuntimeConfig) -> RuntimeConfig:
```

#### 引数

| 名前        | 型                                     | 説明                                               |
| ----------- | -------------------------------------- | -------------------------------------------------- |
| path_or_obj | str \| [RuntimeConfig](#runtimeconfig) | 設定ファイルのパス、またはサーバー設定インスタンス |

#### 戻り値

| 型                              | 説明                                 |
| ------------------------------- | ------------------------------------ |
| [RuntimeConfig](#runtimeconfig) | 初期化されたサーバー設定インスタンス |

#### 処理概要
1. 引数 `path_or_obj` が文字列の場合、その値をファイルパスとして設定ファイルを読み込み、
  サーバー設定インスタンス [`RuntimeConfig`](#runtimeconfig) を生成する。
1. 戻り値としてサーバー設定インスタンスを返却する。


## config
読み込み済みのサーバー設定にアクセスするためのプロキシとなるグローバル変数。  
アプリケーションのどこからでもサーバー設定にアクセスできる。  

#### シグネチャ
```python[config.py]
config: RuntimeConfig
```

#### 依存するライブラリ
- **Werkzeug**： サーバー設定のインスタンスの遅延取得に使用。
- **Flask**： `current_app` から Flask 拡張を取得するために使用。

#### 処理内容
1. [`LocalProxy`](https://werkzeug.palletsprojects.com/en/stable/local/#werkzeug.local.LocalProxy) を使用し、
   `current_app` から Flask 拡張 [`"jairocloud-groups-manager"`](./05.ext.md#jairocloudgroupsmanager) を取得し、`config` 属性を参照する。
