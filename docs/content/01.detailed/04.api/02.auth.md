---
title: api.auth
description: 認証・セッション関連の API エンドポイントを提供する。
---

## bp
認証・セッション関連の API を提供する Blueprint インスタンス。
名前は `"auth"` 、URL プレフィックスは [`router:create_api_blueprint`](./02.router.md#create_api_blueprint) によって `"/api/auth"` に設定される。

#### シグネチャ
```python[auth.py]
bp: Blueprint
```

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。

## login
ログイン機能を提供する

#### シグネチャ
```python[auth.py]
@bp.get("/login")
def login() -> Response:
```

#### エンドポイント
**GET** /api/auth/login

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login** login_user を使用する

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。

#### 戻り値

| 型                          | 説明                                              |
| --------------------------- | ------------------------------------------------- |
| Response                    | リダイレクト                                      |
| ErrorResponse,Literal\[401] | eppn が取得できないなどログイン処理ができない場合 |
| ErrorResponse,Literal\[403] | service を利用する権限がない場合                  |

#### 処理内容
1. ヘッダーから eppn, is_member_of, user_name を取得
2. eppn が無ければログイン失敗として 401 を返却する
3. is_member_of がなければ eppn から [`services.users:get_group_ids_from_eppn`](../05.services/04.users.md#get_group_ids_from_eppn) で所属グループを取得
4. user_name が無ければ eppn から [`service.users:get_user_name_from_eppn](../05.services/04.users.md#get_user_name_from_eppn) でユーザー名を取得する
5. [`ResourceNotFound`](../02.foundation/07.exc.md#resourcenotfound)が発生した場合 401 を返す
6. eppn からグループを取得した場合は `https://cg.gakunin.jp/gr/{group_id}` として is_member_of 形式に変換する
7. is_member_of を引数に [`services.permissions:extract_group_ids`](../05.services/08.permissions.md#extract_group_ids) でグループ ID を取得
8. `services.utils.affiliations:detect_affiliations` を呼び出しロールを取得する
9.  "system_admin", "repository_admin" が含まれていなければ 403 を返却する
10. eppn,is_member_of, user_name から LoginUser オブジェクトを作成
11. [`LoginUser`](../03.entities/12.login-user.md#loginuser) オブジェクトを引数に `flask_login.login_user` を行い認証情報の登録をおこなう
12. `flask.session` から `_id` をキーにセッション ID を取得し [`LoginUser`](../03.entities/12.login-user.md#loginuser) の [`_session_id_`](../03.entities/12.login-user.md#属性) に登録
13. Redis にsession_id をキーに eppn,login_date,is_member_of を登録する
14. クエリパラメータに next があれば next を付加しトップページにリダイレクトする

## load_user

#### シグネチャ
```python[auth.py]
@login_manager.user_loader
def load_user(user_id:str) -> LoginUser | None:
```

#### 依存するライブラリ
- **Flask-Login** LoginManager を使用する

#### デコレータ
- `@login_manager.user_loader`{lang=python}：ユーザーオブジェクトを復元する関数を登録する。

#### 戻り値

| 型        | 説明                         |
| --------- | ---------------------------- |
| LoginUser | ログインユーザーオブジェクト |

#### 処理内容
1. session.get[_id] でsession_id を取得
2. hget_all(\<prefix>\_login_<self.session_id>) でセッション情報を取得
3. eppn がuser_id と一致することを確認し一致しなければ None を返却する
4. セッション情報を取得と session_id でLoginUser オブジェクトを作成し返却する

## logout
ログアウト機能を提供する

#### シグネチャ
```python[auth.py]
@bp.post("/logout")
def logout() -> Response:
```

#### エンドポイント
**GET** /api/auth/logout

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login** logout_user を使用する

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。

#### 戻り値

| 型       | 説明         |
| -------- | ------------ |
| Response | リダイレクト |

#### 処理内容
1. session から session_id を取得
2. Redis の\<prefix>\_login_<self.session_id> の値を削除
3. flask_login.logout_user() を呼び出し
4. レスポンスを作成し、 response.delete_cookie('id')
5. ログインページへリダイレクト
