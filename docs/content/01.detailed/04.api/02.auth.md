---
title: api.auth
description: 認証・セッション関連の API エンドポイントを提供する。
---

## bp
認証・セッション関連の API を提供する Blueprint インスタンス。
名前は `"auth"`、URL プレフィックスは [`router:create_api_blueprint`](./02.router.md#create_api_blueprint) によって `"/api/auth"` に設定される。

#### シグネチャ
```python[auth.py]
bp: Blueprint
```

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。

## login
ログイン機能を提供する

#### シグネチャ
```python[auth.py]
@bp.get("/login")
def login() -> Response:
```

#### エンドポイント
**GET** /api/auth/login

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login** login_userを使用する

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。

#### 戻り値

| 型                         | 説明                                             |
| -------------------------- | ------------------------------------------------ |
| Response                   | リダイレクト                                     |
| ErrorResponse,Literal[401] | eppnが取得できないなどログイン処理ができない場合 |
| ErrorResponse,Literal[403] | serviceを利用する権限がない場合                  |

#### 処理内容
1. ヘッダーからeppn，isMemberOfを取得
2. eppnが無ければログイン失敗として401を返却する
3. isMemberOfがなければeppnから[`services.users:get_group_ids_with_eppn`](../05.services/04.users.md#get_group_ids_with_eppn)で所属グループを取得
4. [`services.users:get_group_ids_with_eppn`](../05.services/04.users.md#get_group_ids_with_eppn)でエラーが発生した場合401を返す
5. eppnからグループを取得した場合はisMemberOf形式に変換する
6. is_member_ofを引数に[`services.permission:get_user_roles`](../05.services/08.permission.md#get_user_roles)で権限を確認し"system_admin", "repository_admin"が含まれていなければ403を返却する
7. eppn,isMemberOfからLoginUserオブジェクトを作成
8.  LoginUserオブジェクトを引数に`login_user()`を行い認証情報の登録をおこなう
9.  session.get("_id")をLoginUserのsession_idに登録
10. Redisにsession_idをキーにeppn,login_date,isMemberOfを登録する
11. クエリパラメータにnextがあればnextを付加しトップページにリダイレクトする

## load_user

#### シグネチャ
```python[auth.py]
@login_manager.user_loader
def load_user(user_id:str) -> LoginUser | None:
```

#### 依存するライブラリ
- **Flask-Login** LoginManagerを使用する

#### デコレータ
- `@login_manager.user_loader`{lang=python}：ユーザーオブジェクトを復元する関数を登録する。

#### 戻り値

| 型        | 説明                         |
| --------- | ---------------------------- |
| LoginUser | ログインユーザーオブジェクト |

#### 処理内容
1. session.get[_id]でsession_idを取得
2. hget_all(\<prefix>\_login_<self.session_id>)でセッション情報を取得
3. eppnがuser_idと一致することを確認し一致しなければNoneを返却する
4. セッション情報を取得とsession_idでLoginUserオブジェクトを作成し返却する

## logout
ログアウト機能を提供する

#### シグネチャ
```python[auth.py]
@bp.post("/logout")
def logout() -> Response:
```

#### エンドポイント
**GET** /api/auth/logout

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login** logout_userを使用する

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。

#### 戻り値

| 型       | 説明         |
| -------- | ------------ |
| Response | リダイレクト |

#### 処理内容
1. sessionからsession_idを取得
2. Redisの\<prefix>\_login_<self.session_id>の値を削除
3. flask_login.logout_user()を呼び出し
4. レスポンスを作成し、response.delete_cookie('id')
5. ログインページへリダイレクト
