---
title: api.auth
description: 認証・セッション関連の API エンドポイントを提供する。
---

## bp
認証・セッション関連の API を提供する Blueprint インスタンス。
名前は `"auth"` 、URL プレフィックスは [`router:create_api_blueprint`](./02.router.md#create_api_blueprint) によって `"/api/auth"` に設定される。

#### シグネチャ
```python[auth.py]
bp: Blueprint
```

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。

## login
ログイン機能を提供する。

#### シグネチャ
```python[auth.py]
@bp.get("/login")
def login() -> Response:
```

#### エンドポイント
**GET** /api/auth/login

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login** login_user を使用する。

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。

#### 戻り値

| 型                          | 説明                                              |
| --------------------------- | ------------------------------------------------- |
| Response                    | リダイレクト                                      |
| ErrorResponse,Literal\[401] | eppn が取得できないなどログイン処理ができない場合 |
| ErrorResponse,Literal\[403] | service を利用する権限がない場合                  |
| ErrorResponse,Literal\[404] | eppnをもとにユーザー情報の取得に失敗した場合      |

#### 処理内容
1. ヘッダーから eppn, is_member_of, user_name を取得する。
2. eppn が無ければログイン失敗として 401 を返却する。
3. is_member_of または user_name がなければ eppn から [`services.users:get_by_eppn`](../05.services/04.users.md#get_by_eppn) で所属グループ，ユーザー名を取得する。
4. 取得できなければ 404 を戻り値として返す。
5. eppn からグループを取得した場合は `https://cg.gakunin.jp/gr/{group_id}` として is_member_of 形式に変換する。
6. is_member_of を引数に [`services.permissions:extract_group_ids`](../05.services/08.permissions.md#extract_group_ids) でグループ ID を取得する。
7. `services.utils.affiliations:detect_affiliations` を呼び出しロールを取得する。
8.  "system_admin", "repository_admin" が含まれていなければ 403 を返却する。
9.  eppn,is_member_of, user_name から LoginUser オブジェクトを作成する。
10. [`LoginUser`](../03.entities/12.login-user.md#loginuser) オブジェクトを引数に `flask_login.login_user` を行い認証情報の登録をおこなう
11. `flask.session` から `_id` をキーにセッション ID を取得し [`LoginUser`](../03.entities/12.login-user.md#loginuser) の [`_session_id`](../03.entities/12.login-user.md#属性) に登録する。
12. アカウントストアへセッション ID をキーに以下の値をハッシュ型でハッシュ型で保存する。
| フィールド | 値                             |
| ---------- | ------------------------------ |
| eppn       | ログインユーザーの eppn        |
| loginDate  | ログインした時間               |
| isMemberOf | ログインユーザーの所属グループ |
| userName   | ログインユーザーの名前         |

1.  クエリパラメータに next があれば next を付加しトップページにリダイレクトする。

#### 備考
isMemberOf 属性は https://cg.gakunin.jp/gr/{group_id} のように url 形式で記述されている


## load_user

#### シグネチャ
```python[auth.py]
@login_manager.user_loader
def load_user(user_id:str) -> LoginUser | None:
```

#### 依存するライブラリ
- **Flask-Login** LoginManager を使用する。

#### デコレータ
- `@login_manager.user_loader`{lang=python}：ユーザーオブジェクトを復元する関数を登録する。

#### 戻り値

| 型        | 説明                         |
| --------- | ---------------------------- |
| LoginUser | ログインユーザーオブジェクト |

#### 処理内容
1. session.get[_id] でsession_id を取得する。
2. session_id を引数に[`build_account_store_key`](../04.api/10.helper.md#build_account_store_key)を呼。び出しキーを取得する
3. キーをもとにアカウントストアからセッション情報を取得する。
4. eppn がuser_id と一致することを確認し一致しなければ None を返却する。
5. セッション情報を取得と session_id でLoginUser オブジェクトを作成し返却する。

## logout
ログアウト機能を提供する。

#### シグネチャ
```python[auth.py]
@bp.post("/logout")
def logout() -> Response:
```

#### エンドポイント
**GET** /api/auth/logout

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login** logout_user を使用する。

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。

#### 戻り値

| 型       | 説明         |
| -------- | ------------ |
| Response | リダイレクト |

#### 処理内容
1. session から session_id を取得する。
2. session_id を引数に[`build_account_store_key`](../04.api/10.helper.md#build_account_store_key)を呼び出しキーを取得する。
3. キーをもとにアカウントストアからセッション情報を削除する。
4. flask_login.logout_user() を呼び出しログアウトする。
5. レスポンスを作成し、 response.delete_cookie('id') で cookie を削除する。
6. ログインページへリダイレクトする。
