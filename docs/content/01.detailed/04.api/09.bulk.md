---
title: api.bulk
description: クライアントサイドが使用するユーザー一括操作関連の API を提供する。
---

## bp
グループ管理関連の API を提供する Blueprint インスタンス。
名前は `"bulk"` 、URL プレフィックスは [`router:create_api_blueprint`](./02.router.md#create_api_blueprint) によって `"/api/bulk"` に設定される。

#### シグネチャ
```python[bulk.py]
bp: Blueprint
```

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。

## upload_file
一括操作するファイルをサーバーにアップロードしバリデーションタスクを開始するエンドポイント

#### シグネチャ
```python[bulk.py]
@bp.post("/upload-file")
@login_required
@roles_required("system_admin", "repository_admin")
@validate(response_by_alias=True)
@with_files
def upload_file(from:str, files: FileStorage) -> tuple[BulkBody, int] | tuple[ErrorResponse, int]::
```

#### エンドポイント
**POST** /api/bulk/upload_file

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.post`{lang=python}： POST リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。
- `@with_files`{lang=python}: `multipart/form-data` からファイルを取得、検証し、データクラスにパッケージ化して関数の引数に注入するデコレータ。

#### 引数
| 名前  | 型                                                          | 説明                       |
| ----- | ----------------------------------------------------------- | -------------------------- |
| from  | [`TagetRepository`](../04.api/07.schema.md#tagetrepository) | 選択されたリポジトリ ID    |
| files | [`UploadFiles`](../04.api/07.schema.md#uploadfiles)         | アップロードされたファイル |

#### 戻り値
| 型                                  | 説明                                       |
| ----------------------------------- | ------------------------------------------ |
| tuple\[BulkBody,Literal\[200]]      | タスク ID とファイルの識別子               |
| tuple\[ErrorResponse,Literal\[400]] | ファイルに不備がある場合のエラーレスポンス |

#### 処理内容
1. UUIDv7 でtemporary_id を作成しファイル名に付加
2. ファイルを仮アップロード用のディレクトリに保存
3. files テーブルに id=temporary_id, file_path, file_content を保存
4. [`services.bulk:delete_temporary_file`](../05.services/05.bulk.md#delete_temporary_file) をcelery のcountdown で呼び出す countdown の秒数はサーバー設定値とする
5. [`services.bulk:validate_upload_data`](../05.services/05.bulk.md#validate_upload_data) を呼び出しファイルのバリデーションを行う celery のタスクを実行する
6.  タスク ID とtemporary_id をBulkBody に入れ返却

## validate_status
バリデーションタスクの実行状況の取得エンドポイント

#### シグネチャ
```python[bulk.py]
@bp.get("/validate/status/<string:task_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate(response_by_alias=True)
def validate_status(task_id: str) -> tuple[BulkBody, int] |tuple[ErrorResponse, int]:
```

#### エンドポイント
**GET** /api/bulk/validate/status/<task_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数
| 名前    | 型  | 説明      |
| ------- | --- | --------- |
| task_id | str | タスク ID |

#### 戻り値
| 型                                  | 説明                             |
| ----------------------------------- | -------------------------------- |
| tuple\[BulkBody,Literal\[200]]      | タスクの status                  |
| tuple\[ErrorResponse,Literal\[404]] | task_id のタスクが存在しない場合 |
| tuple\[ErrorResponse,Literal\[500]] | Redis,DB の接続に失敗した場合    |

#### 処理内容
1. task_id をもとにタスクの status を取得
2. status 取得時に redis.ConnectionError が発生した場合 ErrorResponse とともに 500 を返却
3. status が取得できなければ ErrorResponse とともに 404 を返却
4. status を取得できれば status をBulkBody に入れて返却

## validate_result
一括操作データの検証結果を取得するエンドポイント

#### シグネチャ
```python[bulk.py]
@bp.get("/validate/result/<string:task_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate(response_by_alias=True)
def validate_result(task_id: str) -> tuple[ValidateSummary, int] | tuple[ErrorResponse, int]:
```

#### エンドポイント
**GET** /api/bulk/validate/result/<task_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数
| 名前    | 型  | 説明      |
| ------- | --- | --------- |
| task_id | str | タスク ID |

#### 戻り値
| 型                                     | 説明                             |
| -------------------------------------- | -------------------------------- |
| tuple\[ValidateSummary, Literal\[200]] | データの検証結果                 |
| tuple\[ErrorResponse, Literal\[404]]   | task_id のタスクが存在しない場合 |
| tuple\[ErrorResponse, Literal\[500]]   | Redis,DB の接続に失敗した場合    |

#### 処理内容
1. task_id をもとにタスクの実行結果から履歴 ID を取得する
2. 履歴 ID を引数に [`services.bulk:get_validate_result`](../05.services/05.bulk.md#get_validate_result) で検証結果を取得する
3. task_id のタスクが存在しない場合 404 とともに ErrorResponse を返却
4. Redis,DB の接続に失敗した場合 500 とともに ErrorResponse を返却
5. ValidateSummary を返却する

## missing_user_get
リポジトリに属するがファイルに含まれていないユーザーを取得するエンドポイント

#### シグネチャ
```python[bulk.py]
@bp.get("/missing-user/<string:task_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate(response_by_alias=True)
def missing_user_get(task_id: str) -> tuple[UsersResult, int] | tuple[ErrorResponse, int]:
```

#### エンドポイント
**GET** /api/bulk/missing-user/<task_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数
| 名前    | 型  | 説明      |
| ------- | --- | --------- |
| task_id | str | タスク ID |

#### 戻り値
| 型                                  | 説明                                   |
| ----------------------------------- | -------------------------------------- |
| tuple\[UsersResult,Litaral\[200]]   | ファイルに含まれていないユーザーデータ |
| tuple\[ErrorResponse,Literal\[404]] | task_id のタスクが存在しない場合       |
| tuple\[ErrorResponse,Literal\[500]] | Redis,DB の接続に失敗した場合          |

#### 処理内容
1. task_id をもとにタスクの実行結果から履歴 ID を取得する
2. 取得時に redis.ConnectionError が発生した場合 ErrorResponse とともに 500 を返却
3. task_id のタスクが存在しない場合 404 とともに ErrorResponse を返却
4. list\[UserDetail] をUsersResult に入れ返却

## execute
一括操作タスクの実行をおこなうエンドポイント

#### シグネチャ
```python[bulk.py]
@bp.post("/execute/<string:task_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate(response_by_alias=True)
def execute(body: UploadBody) -> tuple[BulkBody, int]:
```

#### エンドポイント
**POST** /api/bulk/execute/<task_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.post`{lang=python}： POST リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数
| 名前 | 型                                    | 説明                             |
| ---- | ------------------------------------- | -------------------------------- |
| body | [UploadBody](07.schema.md#uploadbody) | 一括操作タスクのリクエストボディ |

#### 戻り値
| 型                             | 説明      |
| ------------------------------ | --------- |
| tuple\[BulkBody,Literal\[200]] | タスク ID |

#### 処理内容
1. [`service.bulk:update_users`](../05.services/05.bulk.md#update_users) をcelery のタスクで実行する
2. task_id をBulkBody に入れて返却

## execute_status
一括操作タスクの実行状況の取得エンドポイント

#### シグネチャ
```python[bulk.py]
@bp.post("/upload-file/<string:task_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def execute_status(task_id: str) -> tuple[BulkBody, int] | tuple[ErrorResponse, int]
```
#### エンドポイント
**GET** /api/bulk/execute/status/<task_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.post`{lang=python}： POST リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数
| 名前    | 型  | 説明      |
| ------- | --- | --------- |
| task_id | str | タスク ID |

#### 戻り値
| 型                                   | 説明                             |
| ------------------------------------ | -------------------------------- |
| tuple\[BulkBody, Literal\[200]]      | タスクの status                  |
| tuple\[ErrorResponse, Literal\[404]] | task_id のタスクが存在しない場合 |
| tuple\[ErrorResponse, Literal\[500]] | Redis 接続に失敗した場合         |

#### 処理内容
1. task_id をもとにタスクの status を取得
2. status 取得時に redis.ConnectionError が発生した場合 ErrorResponse とともに 500 を返却
3. task_id のタスクが存在しない場合 404 とともに ErrorResponse を返却
4. status を取得できれば status をBulkBody に入れて返却

## result
一括操作情報を取得するエンドポイント

#### シグネチャ
```python[bulk.py]
@bp.post("/result/<string:history_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate(response_by_alias=True)
def result(history_id: uuid.UUID,query:UploadQuery) -> tuple[ResultSummary, int]:
```

#### エンドポイント
**GET** /api/bulk/result/<history_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.post`{lang=python}： POST リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数
| 名前       | 型                                                  | 説明                  |
| ---------- | --------------------------------------------------- | --------------------- |
| history_id | uuid.UUID                                           | アップロード履歴の id |
| query      | [`UploadQuery`](../04.api/07.schema.md#uploadquery) | フィルター項目        |

#### 戻り値
| 型                                   | 説明               |
| ------------------------------------ | ------------------ |
| tuple\[ResultSummary, Literal\[200]] | 一括操作結果データ |

#### 処理内容
1. query をもとにフィルターを文字列のリストに変換，ページサイズ，オフセットを取り出す
2. [`services.bulk:get_upload_result`](../05.services/05.bulk.md#get_upload_result) でデータを取得する
3. 例外が発生した場合 ErrorResponse を返却
