---
title: api.groups
description: クライアントサイドが使用するグループ管理関連の API を提供する。
---

## bp
グループ管理関連の API を提供する Blueprint インスタンス。
名前は `"groups"`、URL プレフィックスは [`router:create_api_blueprint`](./02.router.md#create_api_blueprint) によって `"/api/groups"` に設定される。

#### シグネチャ
```python[groups.py]
bp: Blueprint
```

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。


## get
グループの取得・検索の機能を提供するコントローラ。

#### シグネチャ
```python[groups.py]
@bp.get("/")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def get(query: GroupsQuery) -> tuple[GroupResult | ErrorResponse, int]:
```

#### エンドポイント
**GET** /api/groups

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数

| 名前  | 型          | 説明                                   |
| ----- | ----------- | -------------------------------------- |
| query | GroupsQuery | グループ検索条件を含むクエリパラメータ |

#### 戻り値

| 型                                   | 説明                                                           |
| ------------------------------------ | -------------------------------------------------------------- |
| tuple\[GroupResult, Literal\[200]]   | グループの検索結果を含むレスポンス                             |
| tuple\[ErrorResponse, Literal\[403]] | ロールの権限を越える検索条件が指定された場合のエラーレスポンス |
| tuple\[ErrorResponse, Literal\[500]] | 検索処理に失敗した場合のエラーレスポンス                       |

#### 処理内容

1. リクエストコンテキストからログインユーザー情報を取得する。
2. `build_group_search_criteria` を呼び出し、引数 `query` とログインユーザーのロールに基づいた `GroupSearchCriteria` オブジェクトを構築する。  
   検索条件にロールの権限を越える条件が含まれている場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 403 とともに返す。
3. `GroupSearchCriteria` オブジェクトをもとに、`services.groups:search` を呼び出し、グループの検索結果を取得する。
4. 検索処理に失敗した場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 500 とともに返す。
5. 検索結果を `GroupResult` オブジェクトに格納し、ステータスコード 200 とともに返す。


## post
グループの作成の機能を提供するコントローラ。

#### シグネチャ
```python[groups.py]
@bp.post("/")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def post(body: GroupDetail) -> tuple[GroupDetail, int, dict[str, str]] | tuple[ErrorResponse, int]:
```

#### エンドポイント
**POST** /api/groups

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。
- **Flask-Login**： グループ認証を行う。

#### デコレータ
- `@bp.post`{lang=python}： POST リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数

| 名前 | 型          | 説明                                       |
| ---- | ----------- | ------------------------------------------ |
| body | GroupDetail | 作成するグループ情報を含むリクエストボディ |

#### 戻り値

| 型                                                  | 説明                                                       |
| --------------------------------------------------- | ---------------------------------------------------------- |
| tuple\[GroupDetail, Literal\[201], dict\[str, str]] | 作成されたグループ情報と Location ヘッダーを含むレスポンス |
| tuple\[ErrorResponse,Literal\[400]]                 | リクエストの内容に不備がある場合のエラーレスポンス         |
| tuple\[ErrorResponse, Literal\[409]]                | グループIDがすでに存在する場合のエラーレスポンス           |
| tuple\[ErrorResponse, Literal\[500]]                | グループ作成処理に失敗した場合のエラーレスポンス           |

#### 処理内容

1. リクエストコンテキストからログインユーザー情報を取得する。
2. グループIDがすでに存在するかを確認する。  
   存在する場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 409 とともに返す。
3. 引数 `body` をもとに、`services.groups:create` を呼び出し、グループを作成する。
4. グループ作成処理に失敗した場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 500 とともに返す。
5. 作成されたグループ情報を `GroupDetail` オブジェクトとして、ステータスコード 201 および `Location` ヘッダーとともに返す。  
  `Location` ヘッダーには作成されたグループの情報取得 API の絶対 URL を設定する。


## id_get
グループの情報取得の機能を提供するコントローラ。

#### シグネチャ
```python[groups.py]
@bp.get("/<string:group_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def id_get(group_id: str) -> tuple[GroupDetail | ErrorResponse, int]:
```

#### エンドポイント
**GET** /api/groups/<group_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。
- **Flask-Login**： グループ認証を行う。

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数

| 名前     | 型  | 説明       |
| -------- | --- | ---------- |
| group_id | str | グループID |

#### 戻り値

| 型                                   | 説明                                                     |
| ------------------------------------ | -------------------------------------------------------- |
| tuple\[GroupDetail, Literal\[200]]   | グループ情報を含むレスポンス                             |
| tuple\[ErrorResponse, Literal\[403]] | グループ情報へのアクセス権限がない場合のエラーレスポンス |
| tuple\[ErrorResponse, Literal\[404]] | グループが存在しない場合のエラーレスポンス               |
| tuple\[ErrorResponse, Literal\[500]] | グループ情報の取得に失敗した場合のエラーレスポンス       |

**処理内容**
1. リクエストコンテキストからログインユーザー情報を取得する。
2. 引数 `group_id` をもとに、`services.groups:get_by_id` を呼び出し、グループ情報を取得する。
3. グループが存在しなかった場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 404 とともに返す。
4. 取得に失敗した場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 500 とともに返す。
5. 取得されたグループ情報とログインユーザーのロールに基づき、グループ情報へのアクセスできるかを確認する。
   - システム管理者の場合、すべてのグループ情報にアクセスできる。
   - リポジトリ管理者の場合、ログインユーザーが管理するリポジトリに所属するグループにのみアクセスできる。  
     所属リポジトリがログインユーザーの管理するリポジトリに含まれていない場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 403 とともに返す。
6. 取得したグループ情報を `GroupDetail` オブジェクトとして、ステータスコード 200 とともに返す。


## id_put
グループの更新の機能を提供するコントローラ。

#### シグネチャ
```python[groups.py]
@bp.put("/<string:group_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def id_put(group_id: str, body: GroupDetail) -> tuple[GroupDetail | ErrorResponse, int]:
```

#### エンドポイント
**PUT** /api/groups/<group_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。
- **Flask-Login**： グループ認証を行う。

#### デコレータ
- `@bp.put`{lang=python}： PUT リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数

| 名前     | 型          | 説明                                       |
| -------- | ----------- | ------------------------------------------ |
| group_id | str         | グループID                                 |
| body     | GroupDetail | 更新するグループ情報を含むリクエストボディ |

#### 戻り値

| 型                                   | 説明                                                   |
| ------------------------------------ | ------------------------------------------------------ |
| tuple\[GroupDetail, Literal\[200]]   | 更新されたグループ情報を含むレスポンス                 |
| tuple\[ErrorResponse, Literal\[403]] | グループ情報を更新する権限がない場合のエラーレスポンス |
| tuple\[ErrorResponse, Literal\[404]] | グループが存在しない場合のエラーレスポンス             |
| tuple\[ErrorResponse, Literal\[409]] | 更新内容に競合があった場合のエラーレスポンス           |
| tuple\[ErrorResponse, Literal\[500]] | グループ更新処理に失敗した場合のエラーレスポンス       |

#### 処理内容
1. リクエストコンテキストからログインユーザー情報を取得する。
2. 引数 `body` とログインユーザーのロールをもとに、グループを更新できるかを確認する。
   - システム管理者の場合、すべてのグループを更新できる。
   - リポジトリ管理者の場合、ログインユーザーが管理するリポジトリに所属するグループのみ更新できる。  
     すべての所属リポジトリがログインユーザーの管理するリポジトリに含まれていない場合、ステータスコード 403 とともに返す。
3. 引数 `body`, をもとに、`services.groups:update` を呼び出し、グループ情報を更新する。
4. グループが存在しない場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 404 とともに返す。
5. 更新内容に競合があった場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 409 とともに返す。
6. グループ更新処理に失敗した場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 500 とともに返す。
7. 更新されたグループ情報を`GroupDetail` オブジェクトとして、ステータスコード 200 とともに返す。

## id_patche
グループメンバーの追加/除外機能を提供するコントローラー

#### シグネチャ
```python[groups.py]
@bp.patch("/<string:group_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def id_patche(group_id: str,add:list[str],remove:list[str]) -> tuple[GroupDetail | ErrorResponse, int]:
```

#### エンドポイント
**PATCH** /api/groups/<group_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： グループ認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.delete`{lang=python}： DELETE リクエストを処理するエンドポイントを定義する。
- `@bp.post`{lang=python}： POST リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数

| 名前     | 型        | 説明             |
| -------- | --------- | ---------------- |
| group_id | str       | グループID       |
| add      | list[str] | 追加するユーザー |
| remove   | list[str] | 除外するユーザー |

#### 戻り値

| 型                                   | 説明                                                   |
| ------------------------------------ | ------------------------------------------------------ |
| tuple\[GroupDetail, Literal\[200]]   | 更新されたグループ情報を含むレスポンス                 |
| tuple\[ErrorResponse, Literal\[400]] | 更新する内容に不備がある場合のエラーレスポンス         |
| tuple\[ErrorResponse, Literal\[403]] | グループ情報を更新する権限がない場合のエラーレスポンス |
| tuple\[ErrorResponse, Literal\[404]] | グループが存在しない場合のエラーレスポンス             |
| tuple\[ErrorResponse, Literal\[409]] | 更新内容に競合があった場合のエラーレスポンス           |
| tuple\[ErrorResponse, Literal\[500]] | グループ更新処理に失敗した場合のエラーレスポンス       |

#### 処理内容
1. リクエストコンテキストからログインユーザー情報を取得する。
2. 引数 `group_id` とログインユーザーのロールをもとに、グループを更新できるかを確認する。
   - システム管理者の場合、すべてのグループを更新できる。
   - リポジトリ管理者の場合、ログインユーザーが管理するリポジトリに所属するグループのみ更新できる。  
     すべての所属リポジトリがログインユーザーの管理するリポジトリに含まれていない場合、ステータスコード 403 とともに返す。
3. 引数 `group_id`,`add`,`remove` をもとに、`services.groups:update_member` を呼び出し、グループ情報を更新する。
4. グループが存在しない場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 404 とともに返す。
5. 更新内容に競合があった場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 409 とともに返す。
6. グループ更新処理に失敗した場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 500 とともに返す。
7. 更新されたグループ情報を`GroupDetail` オブジェクトとして、ステータスコード 200 とともに返す。


## delete_groups
グループの削除の機能を提供するコントローラ。

#### シグネチャ
```python[groups.py]
@bp.delete("/<string:group_id>")
@bp.post("/delete")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def groups_delete(group_id: str) -> tuple[ Literal[""] | ErrorResponse, int]:
```

#### エンドポイント
**DELETE** /api/groups/<group_id>
**POST** /api/groups/delete

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： グループ認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.delete`{lang=python}： DELETE リクエストを処理するエンドポイントを定義する。
- `@bp.post`{lang=python}： POST リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数

| 名前     | 型  | 説明       |
| -------- | --- | ---------- |
| group_id | str | グループID |

#### 戻り値

| 型                                   | 説明                                             |
| ------------------------------------ | ------------------------------------------------ |
| tuple\[Literal\[""\], Literal\[204]] | 正常にグループが削除された場合のレスポンス       |
| tuple\[ErrorResponse, Literal\[404]] | グループが存在しない場合のエラーレスポンス       |
| tuple\[ErrorResponse, Literal\[500]] | グループ削除処理に失敗した場合のエラーレスポンス |

#### 処理内容
1. リクエストメソッドをがDELETEならば`group_id` とログインユーザーのロールをもとに削除可能か確認する
   - システム管理者の場合、すべてのグループを更新できる。
   - リポジトリ管理者の場合、ログインユーザーが管理するリポジトリに所属するグループのみ更新できる。  
     すべての所属リポジトリがログインユーザーの管理するリポジトリに含まれていない場合、ステータスコード 403 とともに返す。
  - 引数 `group_id` をもとに、`services.groups:delete_by_id` を呼び出し、グループを削除する。
2. リクエストメソッドがPOSSTならばリクエストボディからgroup_idのリストgroup_idsを取得
   - 各group_idに対し削除可能か確認する
   - 引数 `group_ids` をもとに、`services.groups:delete` を呼び出し、グループを削除する。
3. グループが存在しなかった場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 404 とともに返す。
4. グループ削除処理に失敗した場合、`ErrorResponse` オブジェクトを作成し、ステータスコード 500 とともに返す。
5. 正常にグループが削除された場合、空文字列とステータスコード 204 とともに返す。


## TODO
システム管理者が追加されたときにアドミンに追加するメソッドが必要
