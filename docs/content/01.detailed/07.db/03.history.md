---
title: db.history
description: ダウンロード履歴 /アップロード履歴のデータベース保存に用いるマッパーモデルを提供する。
---

## DownloadHistory
ダウンロード履歴のデータベース保存に用いるマッパーモデル定義。  
SQLAlchemy ORM を用いてデータベースの `download_history` テーブルとマッピングされる。  
テーブル定義書 [download_history テーブル ](../../03.db/02.history.md#download_history- テーブル ) を参照。

#### シグネチャ
```python[history.py]
class DownloadHistory(db.Model):
```

#### 依存するライブラリ
- **SQLAlchemy**： ORM として使用。
- **uuid**: 履歴 ID を生成するために使用。

#### 継承元
`SQLAlchemy.Model`

#### クラス属性

| 名前                          | 型        | 説明                                  |
| ----------------------------- | --------- | ------------------------------------- |
| &#95;&#95;tablename&#95;&#95; | str       | テーブル名。 `download_history`       |
| id                            | uuid.UUID | ダウンロード履歴の ID                 |
| timestamp                     | datetime  | ダウンロード日時                      |
| file_id                       | uuid.UUID | ダウンロードファイルの ID             |
| operator_id                   | str       | ダウンロード実行者 ID                 |
| operator_name                 | str       | ダウンロード実行者名                  |
| public                        | bool      | 履歴の公開設定                        |
| parent_id                     | uuid.UUID | 再ダウンロード時の初回ダウンロード ID |

#### マッピング

| カラム名      | データ型                           | 主キー | NULL 許容 | デフォルト値 |
| ------------- | ---------------------------------- | ------ | --------- | ------------ |
| id            | sqlalchemy.UUID                    | Yes    |           |              |
| timestamp     | sqlalchemy.DateTime(timezone=True) |        |           | 協定世界時   |
| file_id       | sqlalchemy.UUID                    |        |           |              |
| operator_id   | sqlalchemy.String(50)              |        |           |              |
| operator_name | sqlalchemy.String(50)              |        |           |              |
| public        | sqlalchemy.Boolean                 |        |           | True         |
| parent_id     | sqlalchemy.UUID                    |        | Yes       |              |

#### リレーションシップ

| 名前      | 対象               | 多重度      |
| --------- | ------------------ | ----------- |
| file_id   | Files.file_id      | Many to One |
| parent_id | DownloadHistory.id | Many to One |


#### 備考
- 48 ビットの UNIX エポックミリ秒タイムスタンプが含まれており B-tree インデックスにおいて非常に効率的であるため `id`,`file_id` は UUIDv7 を採用

## UploadHistory
アップロード履歴のデータベース保存に用いるマッパーモデル定義。  
SQLAlchemy ORM を用いてデータベースの `upload_history` テーブルとマッピングされる。  
テーブル定義書 [upload_history テーブル ](../../03.db/02.history.md#upload_history- テーブル ) を参照。

#### シグネチャ
```python[history.py]
class UploadHistory(db.Model):
```

#### 依存するライブラリ
- **SQLAlchemy**： ORM として使用。

#### 継承元
`SQLAlchemy.Model`

#### クラス属性

| 名前                          | 型        | 説明                             |
| ----------------------------- | --------- | -------------------------------- |
| &#95;&#95;tablename&#95;&#95; | str       | テーブル名。 `upload_history`    |
| id                            | uuid.UUID | アップロード履歴の ID            |
| timestamp                     | datetime  | アップロード開始日時             |
| end_timestamp                 | datetime  | アップロード終了日時             |
| file_id                       | uuid.UUID | アップロードファイルの ID        |
| operator_id                   | str       | アップロード実行者 ID            |
| operator_name                 | str       | アップロード実行者名             |
| public                        | bool      | 履歴の公開設定                   |
| status                        | Status    | アップロード状況                 |
| results                       | dict      | アップロード結果                 |

#### マッピング

| カラム名      | データ型                           | 主キー | NULL 許容 | デフォルト値 |
| ------------- | ---------------------------------- | ------ | --------- | ------------ |
| id            | sqlalchemy.UUID                    | Yes    |           |              |
| timestamp     | sqlalchemy.DateTime(timezone=True) |        |           | 協定世界時   |
| end_timestamp | sqlalchemy.DateTime(timezone=True) |        | Yes       |              |
| file_id       | sqlalchemy.UUID                    |        |           |              |
| operator_id   | sqlalchemy.String(50)              |        |           |              |
| operator_name | sqlalchemy.String(50)              |        |           |              |
| public        | sqlalchemy.Boolean                 |        |           | True         |
| status        | sqlalchemy.String(1)               |        |           |              |
| results       | sqlalchemy.ext.mutable.MutableDict |        | Yes       |              |

#### リレーションシップ

| 名前    | 対象          | 多重度      |
| ------- | ------------- | ----------- |
| file_id | Files.file_id | Many to One |

#### 備考
- `results` カラムは PostgreSQL で JSONB 型を使用する。
- 48 ビットの UNIX エポックミリ秒タイムスタンプが含まれており B-tree インデックスにおいて非常に効率的であるため `id`,`file_id` は UUIDv7 を採用

### Status
status フィールドの要素に対応する型エイリアス。

#### シグネチャ
```python[history.py]
type Status = typing.Literal["S", "P", "F", "C"]
```

#### 備考
それぞれ対応は以下の通り
- S: Success
- P: In Progress
- F: Failed
- C: Cancel

## Files
ダウンロード /アップロードに用いたファイル情報のデータベース保存に用いるマッパーモデル定義。  
SQLAlchemy ORM を用いてデータベースの `files` テーブルとマッピングされる。  
テーブル定義書 [files テーブル ](../../03.db/02.history.md#files- テーブル ) を参照。

#### シグネチャ
```python[history.py]
class Files(db.Model):
```

#### 依存するライブラリ
- **SQLAlchemy**： ORM として使用。

#### 継承元
`SQLAlchemy.Model`

#### クラス属性

| 名前                          | 型        | 説明                         |
| ----------------------------- | --------- | ---------------------------- |
| &#95;&#95;tablename&#95;&#95; | str       | テーブル名。 `files`         |
| id                            | uuid.UUID | ファイル ID                  |
| file_path                     | str       | ファイルパス                 |
| file_content                  | dict      | ファイル内のユーザー等の情報 |

#### マッピング

| カラム名     | データ型                           | 主キー | NULL 許容 | デフォルト値 |
| ------------ | ---------------------------------- | ------ | --------- | ------------ |
| id           | sqlalchemy.UUID                    | Yes    |           |              |
| file_path    | sqlalchemy.String(1024)            |        |           |              |
| file_content | sqlalchemy.ext.mutable.MutableDict |        |           |              |


#### リレーションシップ

| 名前 | 対象                    | 多重度      |
| ---- | ----------------------- | ----------- |
| id   | DownloadHistory.file_id | One to Many |
| id   | UploadHistory.file_id   | One to Many |

#### 備考
- `file_content` カラムは PostgreSQL で JSONB 型を使用する。
- 48 ビットの UNIX エポックミリ秒タイムスタンプが含まれており B-tree インデックスにおいて非常に効率的であるため `id` は UUIDv7 を採用
